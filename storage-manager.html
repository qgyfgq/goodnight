<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­˜å‚¨ç©ºé—´ç®¡ç†</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.2);
    }
    h1 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .storage-info {
      background: #f8f9fa;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .storage-bar {
      height: 1rem;
      background: #e9ecef;
      border-radius: 0.5rem;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .storage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
      transition: width 0.3s ease;
    }
    .storage-text {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
    }
    .item-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .item-name {
      font-weight: 600;
      color: #333;
    }
    .item-size {
      font-size: 0.8rem;
      color: #888;
    }
    .item-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .item-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }
    .item-btn.delete:hover {
      background: #fecaca;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    .btn.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
    }
    .btn.danger {
      background: #dc3545;
      color: #fff;
    }
    .btn.danger:hover {
      background: #c82333;
    }
    .btn.secondary {
      background: #6c757d;
      color: #fff;
    }
    .btn.secondary:hover {
      background: #5a6268;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #856404;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #155724;
      display: none;
    }
    .tip {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #e7f3ff;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      color: #0066cc;
    }
    .tip h3 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .tip ul {
      margin-left: 1.2rem;
    }
    .tip li {
      margin-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ å­˜å‚¨ç©ºé—´ç®¡ç†</h1>
    
    <div class="storage-info">
      <div class="storage-bar">
        <div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div>
      </div>
      <div class="storage-text" id="storageText">è®¡ç®—ä¸­...</div>
    </div>

    <div class="success" id="successMsg">æ“ä½œæˆåŠŸï¼</div>

    <div class="item-list" id="itemList"></div>

    <div class="warning">
      âš ï¸ åˆ é™¤æ•°æ®åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
    </div>

    <div class="actions">
      <button class="btn primary" onclick="refreshStorage()">ğŸ”„ åˆ·æ–°å­˜å‚¨ä¿¡æ¯</button>
      <button class="btn danger" onclick="clearAllStorage()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      <button class="btn secondary" onclick="window.location.href='index.html'">â† è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="tip">
      <h3>ğŸ’¡ èŠ‚çœå­˜å‚¨ç©ºé—´çš„å»ºè®®ï¼š</h3>
      <ul>
        <li>ä½¿ç”¨å›¾ç‰‡é“¾æ¥ï¼ˆURLï¼‰ä»£æ›¿ä¸Šä¼ å›¾ç‰‡</li>
        <li>å®šæœŸæ¸…ç†ä¸éœ€è¦çš„èŠå¤©è®°å½•</li>
        <li>åˆ é™¤ä¸å†ä½¿ç”¨çš„è”ç³»äºº</li>
        <li>æ¸…ç†æ—§çš„åŠ¨æ€æ•°æ®</li>
      </ul>
    </div>
  </div>

  <script>
    // å­˜å‚¨é¡¹é…ç½®
    const storageItems = [
      { key: 'xinliaoContacts', name: 'è”ç³»äººæ•°æ®', icon: 'ğŸ‘¥' },
      { key: 'xinliaoChats', name: 'ä¼šè¯åˆ—è¡¨', icon: 'ğŸ’¬' },
      { key: 'xinliaoMoments', name: 'åŠ¨æ€æ•°æ®', icon: 'ğŸ“·' },
      { key: 'xinliaoCover', name: 'åŠ¨æ€å°é¢å›¾', icon: 'ğŸ–¼ï¸' },
      { key: 'xinliaoUserAvatar', name: 'ç”¨æˆ·å¤´åƒ', icon: 'ğŸ‘¤' },
      { key: 'xinliaoUserName', name: 'ç”¨æˆ·æ˜µç§°', icon: 'ğŸ“' },
      { key: 'apiProfiles', name: 'API é…ç½®', icon: 'âš™ï¸' },
      { key: 'activeProfileId', name: 'å½“å‰é…ç½® ID', icon: 'ğŸ”‘' },
    ];

    // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // è·å–å­˜å‚¨é¡¹å¤§å°
    function getItemSize(key) {
      const value = localStorage.getItem(key);
      if (!value) return 0;
      return new Blob([value]).size;
    }

    // è·å–æ€»å­˜å‚¨å¤§å°
    function getTotalSize() {
      let total = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        total += getItemSize(key);
      }
      return total;
    }

    // è·å–èŠå¤©è®°å½•çš„å­˜å‚¨é¡¹
    function getChatMessageKeys() {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('xinliaoChatMessages_')) {
          keys.push(key);
        }
      }
      return keys;
    }

    // åˆ·æ–°å­˜å‚¨ä¿¡æ¯
    function refreshStorage() {
      const totalSize = getTotalSize();
      const maxSize = 5 * 1024 * 1024; // å‡è®¾ 5MB é™åˆ¶
      const percentage = Math.min((totalSize / maxSize) * 100, 100);

      document.getElementById('storageBarFill').style.width = percentage + '%';
      document.getElementById('storageText').textContent = 
        `å·²ä½¿ç”¨ ${formatBytes(totalSize)} / çº¦ ${formatBytes(maxSize)} (${percentage.toFixed(1)}%)`;

      // æ¸²æŸ“å­˜å‚¨é¡¹åˆ—è¡¨
      const itemList = document.getElementById('itemList');
      let html = '';

      // æ·»åŠ é¢„å®šä¹‰çš„å­˜å‚¨é¡¹
      for (const item of storageItems) {
        const size = getItemSize(item.key);
        if (size > 0) {
          html += `
            <div class="item">
              <div class="item-info">
                <span class="item-name">${item.icon} ${item.name}</span>
                <span class="item-size">${formatBytes(size)}</span>
              </div>
              <button class="item-btn delete" onclick="deleteItem('${item.key}')">åˆ é™¤</button>
            </div>
          `;
        }
      }

      // æ·»åŠ èŠå¤©è®°å½•
      const chatKeys = getChatMessageKeys();
      if (chatKeys.length > 0) {
        let chatTotalSize = 0;
        chatKeys.forEach(key => {
          chatTotalSize += getItemSize(key);
        });
        html += `
          <div class="item">
            <div class="item-info">
              <span class="item-name">ğŸ’­ èŠå¤©è®°å½• (${chatKeys.length} ä¸ªä¼šè¯)</span>
              <span class="item-size">${formatBytes(chatTotalSize)}</span>
            </div>
            <button class="item-btn delete" onclick="deleteChatMessages()">åˆ é™¤å…¨éƒ¨</button>
          </div>
        `;
      }

      if (!html) {
        html = '<div class="item"><div class="item-info"><span class="item-name">æš‚æ— å­˜å‚¨æ•°æ®</span></div></div>';
      }

      itemList.innerHTML = html;
    }

    // åˆ é™¤å•ä¸ªå­˜å‚¨é¡¹
    function deleteItem(key) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤ "${key}" å—ï¼Ÿ`)) {
        localStorage.removeItem(key);
        showSuccess();
        refreshStorage();
      }
    }

    // åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•
    function deleteChatMessages() {
      if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
        const chatKeys = getChatMessageKeys();
        chatKeys.forEach(key => {
          localStorage.removeItem(key);
        });
        showSuccess();
        refreshStorage();
      }
    }

    // æ¸…ç©ºæ‰€æœ‰å­˜å‚¨
    function clearAllStorage() {
      if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰è”ç³»äººã€èŠå¤©è®°å½•ã€åŠ¨æ€ç­‰æ•°æ®ï¼')) {
          localStorage.clear();
          showSuccess();
          refreshStorage();
        }
      }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess() {
      const msg = document.getElementById('successMsg');
      msg.style.display = 'block';
      setTimeout(() => {
        msg.style.display = 'none';
      }, 2000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°
    refreshStorage();
  </script>
</body>
</html>
