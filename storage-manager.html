<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­˜å‚¨ç©ºé—´ç®¡ç†</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.2);
    }
    h1 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .storage-info {
      background: #f8f9fa;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .storage-bar {
      height: 1rem;
      background: #e9ecef;
      border-radius: 0.5rem;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .storage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
      transition: width 0.3s ease;
    }
    .storage-text {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #666;
      margin: 1rem 0 0.5rem;
      padding-left: 0.5rem;
    }
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
    }
    .item.idb {
      border-color: #d4edda;
      background: #f8fff9;
    }
    .item-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .item-name {
      font-weight: 600;
      color: #333;
    }
    .item-size {
      font-size: 0.8rem;
      color: #888;
    }
    .item-badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      background: #e7f3ff;
      color: #0066cc;
      margin-left: 0.5rem;
    }
    .item-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .item-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }
    .item-btn.delete:hover {
      background: #fecaca;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    .btn.primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
    }
    .btn.danger {
      background: #dc3545;
      color: #fff;
    }
    .btn.danger:hover {
      background: #c82333;
    }
    .btn.secondary {
      background: #6c757d;
      color: #fff;
    }
    .btn.secondary:hover {
      background: #5a6268;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #856404;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #155724;
      display: none;
    }
    .tip {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #e7f3ff;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      color: #0066cc;
    }
    .tip h3 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .tip ul {
      margin-left: 1.2rem;
    }
    .tip li {
      margin-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ å­˜å‚¨ç©ºé—´ç®¡ç†</h1>
    
    <div class="storage-info">
      <div class="storage-bar">
        <div class="storage-bar-fill" id="storageBarFill" style="width: 0%"></div>
      </div>
      <div class="storage-text" id="storageText">è®¡ç®—ä¸­...</div>
    </div>

    <div class="success" id="successMsg">æ“ä½œæˆåŠŸï¼</div>

    <div class="section-title">ğŸ“ localStorage æ•°æ®</div>
    <div class="item-list" id="localStorageList"></div>

    <div class="section-title">ğŸ—„ï¸ IndexedDB æ•°æ®</div>
    <div class="item-list" id="indexedDBList"></div>

    <div class="warning">
      âš ï¸ åˆ é™¤æ•°æ®åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
    </div>

    <div class="actions">
      <button class="btn primary" onclick="refreshStorage()">ğŸ”„ åˆ·æ–°å­˜å‚¨ä¿¡æ¯</button>
      <button class="btn danger" onclick="clearAllStorage()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      <button class="btn secondary" onclick="window.location.href='index.html'">â† è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="tip">
      <h3>ğŸ’¡ èŠ‚çœå­˜å‚¨ç©ºé—´çš„å»ºè®®ï¼š</h3>
      <ul>
        <li>ä½¿ç”¨å›¾ç‰‡é“¾æ¥ï¼ˆURLï¼‰ä»£æ›¿ä¸Šä¼ å›¾ç‰‡</li>
        <li>å®šæœŸæ¸…ç†ä¸éœ€è¦çš„èŠå¤©è®°å½•</li>
        <li>åˆ é™¤ä¸å†ä½¿ç”¨çš„è”ç³»äºº</li>
        <li>æ¸…ç†æ—§çš„åŠ¨æ€æ•°æ®</li>
      </ul>
    </div>
  </div>

  <script>
    // IndexedDB é…ç½®
    const DB_NAME = 'goodnightDB';
    const DB_VERSION = 1;
    const STORES = {
      chats: 'chats',
      chatMessages: 'chatMessages',
      contacts: 'contacts',
      moments: 'moments',
      worldbook: 'worldbook',
      settings: 'settings',
    };

    let db = null;

    // åˆå§‹åŒ– IndexedDB
    async function initDB() {
      return new Promise((resolve, reject) => {
        if (db) {
          resolve(db);
          return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          for (const storeName of Object.values(STORES)) {
            if (!database.objectStoreNames.contains(storeName)) {
              if (storeName === 'chatMessages') {
                database.createObjectStore(storeName, { keyPath: 'chatId' });
              } else if (storeName === 'settings' || storeName === 'worldbook') {
                database.createObjectStore(storeName, { keyPath: 'key' });
              } else {
                database.createObjectStore(storeName, { keyPath: 'id' });
              }
            }
          }
        };
      });
    }

    // è·å– IndexedDB å­˜å‚¨çš„æ‰€æœ‰æ•°æ®
    async function getAllFromStore(storeName) {
      await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }

    // æ¸…ç©º IndexedDB å­˜å‚¨
    async function clearStore(storeName) {
      await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // localStorage å­˜å‚¨é¡¹é…ç½®
    const storageItems = [
      { key: 'xinliaoContacts', name: 'è”ç³»äººæ•°æ®', icon: 'ğŸ‘¥' },
      { key: 'xinliaoMoments', name: 'åŠ¨æ€æ•°æ®', icon: 'ğŸ“·' },
      { key: 'xinliaoCover', name: 'åŠ¨æ€å°é¢å›¾', icon: 'ğŸ–¼ï¸' },
      { key: 'xinliaoUserAvatar', name: 'ç”¨æˆ·å¤´åƒ', icon: 'ğŸ‘¤' },
      { key: 'xinliaoUserName', name: 'ç”¨æˆ·æ˜µç§°', icon: 'ğŸ“' },
      { key: 'apiProfiles', name: 'API é…ç½®', icon: 'âš™ï¸' },
      { key: 'activeProfileId', name: 'å½“å‰é…ç½® ID', icon: 'ğŸ”‘' },
      { key: 'soundSettings', name: 'æç¤ºéŸ³è®¾ç½®', icon: 'ğŸ”Š' },
    ];

    // IndexedDB å­˜å‚¨é¡¹é…ç½®
    const idbStoreItems = [
      { store: 'chats', name: 'ä¼šè¯åˆ—è¡¨', icon: 'ğŸ’¬' },
      { store: 'chatMessages', name: 'èŠå¤©è®°å½•', icon: 'ğŸ’­' },
      { store: 'contacts', name: 'è”ç³»äºº (IDB)', icon: 'ğŸ‘¥' },
      { store: 'moments', name: 'åŠ¨æ€ (IDB)', icon: 'ğŸ“·' },
      { store: 'settings', name: 'è®¾ç½® (IDB)', icon: 'âš™ï¸' },
    ];

    // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // è·å–å­˜å‚¨é¡¹å¤§å°
    function getItemSize(key) {
      const value = localStorage.getItem(key);
      if (!value) return 0;
      return new Blob([value]).size;
    }

    // è·å–æ€»å­˜å‚¨å¤§å°
    function getTotalSize() {
      let total = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        total += getItemSize(key);
      }
      return total;
    }

    // è·å–èŠå¤©è®°å½•çš„å­˜å‚¨é¡¹ï¼ˆæ—§ç‰ˆ localStorageï¼‰
    function getChatMessageKeys() {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('xinliaoChatMessages_')) {
          keys.push(key);
        }
      }
      return keys;
    }

    // åˆ·æ–°å­˜å‚¨ä¿¡æ¯
    async function refreshStorage() {
      let totalSize = getTotalSize();

      // æ¸²æŸ“ localStorage åˆ—è¡¨
      const localStorageList = document.getElementById('localStorageList');
      let localHtml = '';

      // æ·»åŠ é¢„å®šä¹‰çš„å­˜å‚¨é¡¹
      for (const item of storageItems) {
        const size = getItemSize(item.key);
        if (size > 0) {
          localHtml += `
            <div class="item">
              <div class="item-info">
                <span class="item-name">${item.icon} ${item.name}</span>
                <span class="item-size">${formatBytes(size)}</span>
              </div>
              <button class="item-btn delete" onclick="deleteItem('${item.key}')">åˆ é™¤</button>
            </div>
          `;
        }
      }

      // æ·»åŠ æ—§ç‰ˆèŠå¤©è®°å½•ï¼ˆlocalStorageï¼‰
      const chatKeys = getChatMessageKeys();
      if (chatKeys.length > 0) {
        let chatTotalSize = 0;
        chatKeys.forEach(key => {
          chatTotalSize += getItemSize(key);
        });
        localHtml += `
          <div class="item">
            <div class="item-info">
              <span class="item-name">ğŸ’­ æ—§ç‰ˆèŠå¤©è®°å½• (${chatKeys.length} ä¸ªä¼šè¯)</span>
              <span class="item-size">${formatBytes(chatTotalSize)}</span>
            </div>
            <button class="item-btn delete" onclick="deleteChatMessages()">åˆ é™¤å…¨éƒ¨</button>
          </div>
        `;
      }

      // æ£€æŸ¥æ—§ç‰ˆä¼šè¯åˆ—è¡¨
      const oldChatsSize = getItemSize('xinliaoChats');
      if (oldChatsSize > 0) {
        localHtml += `
          <div class="item">
            <div class="item-info">
              <span class="item-name">ğŸ’¬ æ—§ç‰ˆä¼šè¯åˆ—è¡¨</span>
              <span class="item-size">${formatBytes(oldChatsSize)}</span>
            </div>
            <button class="item-btn delete" onclick="deleteItem('xinliaoChats')">åˆ é™¤</button>
          </div>
        `;
      }

      if (!localHtml) {
        localHtml = '<div class="item"><div class="item-info"><span class="item-name">æš‚æ—  localStorage æ•°æ®</span></div></div>';
      }

      localStorageList.innerHTML = localHtml;

      // æ¸²æŸ“ IndexedDB åˆ—è¡¨
      const indexedDBList = document.getElementById('indexedDBList');
      let idbHtml = '';
      let idbTotalSize = 0;

      try {
        await initDB();

        for (const item of idbStoreItems) {
          const data = await getAllFromStore(item.store);
          if (data.length > 0) {
            const size = new Blob([JSON.stringify(data)]).size;
            idbTotalSize += size;
            idbHtml += `
              <div class="item idb">
                <div class="item-info">
                  <span class="item-name">${item.icon} ${item.name}<span class="item-badge">IndexedDB</span></span>
                  <span class="item-size">${formatBytes(size)} (${data.length} æ¡)</span>
                </div>
                <button class="item-btn delete" onclick="clearIDBStore('${item.store}')">åˆ é™¤</button>
              </div>
            `;
          }
        }
      } catch (error) {
        console.warn('è¯»å– IndexedDB å¤±è´¥:', error);
      }

      if (!idbHtml) {
        idbHtml = '<div class="item"><div class="item-info"><span class="item-name">æš‚æ—  IndexedDB æ•°æ®</span></div></div>';
      }

      indexedDBList.innerHTML = idbHtml;

      // æ›´æ–°æ€»å­˜å‚¨ä¿¡æ¯
      totalSize += idbTotalSize;
      const maxSize = 50 * 1024 * 1024; // IndexedDB æ”¯æŒæ›´å¤§å®¹é‡
      const percentage = Math.min((totalSize / maxSize) * 100, 100);

      document.getElementById('storageBarFill').style.width = percentage + '%';
      document.getElementById('storageText').textContent = 
        `å·²ä½¿ç”¨ ${formatBytes(totalSize)} / çº¦ ${formatBytes(maxSize)} (${percentage.toFixed(1)}%)`;
    }

    // åˆ é™¤å•ä¸ª localStorage å­˜å‚¨é¡¹
    function deleteItem(key) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤ "${key}" å—ï¼Ÿ`)) {
        localStorage.removeItem(key);
        showSuccess();
        refreshStorage();
      }
    }

    // åˆ é™¤æ‰€æœ‰æ—§ç‰ˆèŠå¤©è®°å½•ï¼ˆlocalStorageï¼‰
    function deleteChatMessages() {
      if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ—§ç‰ˆèŠå¤©è®°å½•å—ï¼Ÿ')) {
        const chatKeys = getChatMessageKeys();
        chatKeys.forEach(key => {
          localStorage.removeItem(key);
        });
        showSuccess();
        refreshStorage();
      }
    }

    // æ¸…ç©º IndexedDB å­˜å‚¨
    async function clearIDBStore(storeName) {
      const storeItem = idbStoreItems.find(item => item.store === storeName);
      const displayName = storeItem ? storeItem.name : storeName;
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤ "${displayName}" å—ï¼Ÿ`)) {
        try {
          await clearStore(storeName);
          showSuccess();
          refreshStorage();
        } catch (error) {
          alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
      }
    }

    // æ¸…ç©ºæ‰€æœ‰å­˜å‚¨
    async function clearAllStorage() {
      if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰è”ç³»äººã€èŠå¤©è®°å½•ã€åŠ¨æ€ç­‰æ•°æ®ï¼')) {
          // æ¸…ç©º localStorage
          localStorage.clear();

          // æ¸…ç©º IndexedDB
          try {
            await initDB();
            for (const storeName of Object.values(STORES)) {
              await clearStore(storeName);
            }
          } catch (error) {
            console.warn('æ¸…ç©º IndexedDB å¤±è´¥:', error);
          }

          showSuccess();
          refreshStorage();
        }
      }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess() {
      const msg = document.getElementById('successMsg');
      msg.style.display = 'block';
      setTimeout(() => {
        msg.style.display = 'none';
      }, 2000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°
    refreshStorage();
  </script>
</body>
</html>
